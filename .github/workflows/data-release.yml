name: Data release (triggered)

on:
  repository_dispatch:
    types: [data-release]
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write
  packages: write

jobs:
  data_release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Show dispatch payload
        run: |
          echo "DISPATCH_PAYLOAD=$GITHUB_EVENT" | sed -n '1,200p'

      - name: Install deps (fast)
        run: python -m pip install --upgrade pip

      - name: Validate snapshot presence
        id: check_changes
        run: |
          set -euo pipefail
          # If the dispatch payload provides a branch, fetch it
          BRANCH=$(jq -r '.client_payload.branch // empty' < "$GITHUB_EVENT_PATH")
          if [ -n "$BRANCH" ]; then
            git fetch origin "$BRANCH":"$BRANCH" || true
            git checkout "$BRANCH"
          fi
          # Check for any changes in gamebot_lite/data
          if git status --porcelain --untracked-files=no | grep -q "gamebot_lite/data"; then
            echo "changes=true" >> "$GITHUB_OUTPUT"
          else
            echo "changes=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Exit early if no data changes
        if: steps.check_changes.outputs.changes == 'false'
        run: |
          echo "No changes detected in gamebot_lite/data. Nothing to release."

      - name: Run smoke test and tagging steps
        if: steps.check_changes.outputs.changes == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          # Ensure the packaged sqlite exists
          SQLITE=$(ls gamebot_lite/data/*.sqlite 2>/dev/null || true)
          if [ -z "$SQLITE" ]; then
            echo "No sqlite file found in gamebot_lite/data/. Aborting." >&2
            exit 2
          fi

          # Run smoke test
          python -m pip install --upgrade pip
          python -m pip install --upgrade sqlite3 || true
          python scripts/smoke_gamebot_lite.py || { echo "Smoke test failed"; exit 3; }

          # Commit message and tag
          TAG="data-$(date -u +%Y%m%d)"
          git config user.email "ci@gamebot.local"
          git config user.name "gamebot-ci"

          # If there are uncommitted changes (branch was pushed by Airflow), commit them
          if [ -n "$(git status --porcelain)" ]; then
            git add gamebot_lite/data || true
            git commit -m "chore(data): packaged sqlite snapshot ($TAG)" || true
            git push origin HEAD || true
          fi

          # Create tag if not exists
          if ! git rev-parse "$TAG" >/dev/null 2>&1; then
            git tag "$TAG"
            git push origin --tags
          fi

          # If a PR number was supplied, merge it
          PR_NUM=$(jq -r '.client_payload.pr_number // empty' < "$GITHUB_EVENT_PATH")
          if [ -n "$PR_NUM" ]; then
            echo "Merging PR #$PR_NUM"
            gh auth setup-git && true
            # Use GitHub API to merge
            curl -sS -X PUT -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUM/merge" \
              -d '{"merge_method":"merge"}' || true
          fi

      - name: Create release (optional)
        if: steps.check_changes.outputs.changes == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="data-$(date -u +%Y%m%d)"
          gh release create "$TAG" gamebot_lite/data/*.sqlite --notes "Automated data release $TAG" || true
